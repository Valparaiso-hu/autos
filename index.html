<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SISTEMA VEHICULAR — Civil / Policía / Moderador</title>
<style>
  :root{
    --purple-1:#4b1070;
    --purple-2:#7a3fb2;
    --white:#ffffff;
    --muted:#6b6b6b;
    --danger:#b00020;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  body{margin:0;background:var(--white);color:var(--purple-1);min-height:100vh;}
  .wrap{max-width:1100px;margin:24px auto;padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  .title{font-size:24px;font-weight:800;color:var(--purple-1)}
  .subtitle{color:var(--muted);font-size:13px}
  /* layout */
  .layout{display:grid;grid-template-columns:1fr 360px;gap:20px}
  @media (max-width:880px){.layout{grid-template-columns:1fr}}
  /* Panels */
  .panel{background:linear-gradient(180deg,#fff,#fafafa);border:1px solid rgba(122,63,178,0.06);padding:16px;border-radius:12px}
  .panel h3{margin:0 0 8px 0;color:var(--purple-1)}
  label{display:block;margin-top:12px;margin-bottom:6px;color:var(--purple-1)}
  input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(122,63,178,0.08);font-size:14px;color:var(--purple-1)}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--purple-2);color:var(--white);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:2px solid var(--purple-2);color:var(--purple-1)}
  .btn.small{padding:8px 10px;font-size:14px}
  .btn.delete{background:#ffe6ea;color:var(--danger);border:1px solid rgba(176,0,32,0.08)}
  /* cards */
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .veh-card{background:linear-gradient(180deg,rgba(122,63,178,0.06),rgba(75,16,112,0.02));padding:12px;border-radius:10px;border:1px solid rgba(122,63,178,0.06);color:var(--purple-1);min-height:120px;position:relative}
  .veh-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .chip{background:rgba(122,63,178,0.06);padding:6px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(122,63,178,0.04)}
  .empty{background:#fff5ff;border:1px solid rgba(122,63,178,0.06);padding:14px;border-radius:10px;color:var(--muted)}
  .footer-note{font-size:13px;color:var(--muted);margin-top:10px}
  /* overlay/modal */
  .overlay{position:fixed;inset:0;background:rgba(75,16,112,0.12);display:flex;align-items:center;justify-content:center;z-index:999}
  .modal{width:96%;max-width:520px;background:var(--white);border:3px solid var(--purple-2);padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(75,16,112,0.08)}
  .modal h2{margin:0 0 8px;color:var(--purple-1)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .search-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input.search{padding:8px;border-radius:8px;border:1px solid rgba(122,63,178,0.08);width:240px}
  small.note{display:block;color:var(--muted);margin-top:8px}
  .status-badge{padding:6px 8px;border-radius:8px;font-weight:700}
  .status-neutro{background:#eef2ff;color:var(--purple-1)}
  .status-incautado{background:#fff4e6;color:#b85a00}
  .status-confiscado{background:#ffe6ea;color:var(--danger)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">SISTEMA VEHICULAR</div>
      <div class="subtitle">Modos: Civil / Policía / Moderador — Tema blanco/morado</div>
    </div>
    <div class="subtitle">Estática + JSONBin</div>
  </header>

  <!-- search + info -->
  <div style="margin-bottom:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <div class="search-row">
      <input id="searchInput" class="search" placeholder="Buscar por propietario (nombre)">
      <button id="btnBuscar" class="btn small">Buscar</button>
      <button id="btnClearSearch" class="btn ghost small">Limpiar búsqueda</button>
    </div>

    <div style="margin-left:auto">
      <button id="btnOpenLogin" class="btn small">Panel de inicio de sesión</button>
    </div>
  </div>

  <main class="layout">
    <!-- main: cards -->
    <section>
      <div id="notice" class="panel" style="margin-bottom:12px;display:none">
        <div class="muted">Modo visible: cambia según tu acceso.</div>
      </div>

      <div id="emptyState" class="empty" style="display:none">No hay vehículos registrados.</div>
      <div id="cards" class="cards" style="margin-top:12px"></div>
    </section>

    <!-- sidebar: moderator form -->
    <aside>
      <div id="moderatorPanel" class="panel" style="display:none">
        <h3>Panel Moderador</h3>
        <div class="muted">Registrar vehículo (solo Moderador).</div>

        <label>Contraseña de formulario (Moderador)</label>
        <input id="moderPass" type="password" placeholder="Contraseña del formulario (ModeracionCHCRP)">

        <label for="rut">RUT</label>
        <input id="rut" type="text" placeholder="12.345.678-9">

        <label for="propietario">Propietario</label>
        <input id="propietario" type="text" placeholder="Nombre completo">

        <label for="marca">Marca</label>
        <input id="marca" type="text" placeholder="Toyota">

        <label for="modelo">Modelo</label>
        <input id="modelo" type="text" placeholder="Corolla">

        <label for="patente">Patente</label>
        <input id="patente" type="text" placeholder="ABC123">

        <label for="color">Color</label>
        <input id="color" type="text" placeholder="Blanco">

        <label for="anio">Año</label>
        <input id="anio" type="number" placeholder="2020" min="1900" max="2099">

        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="btnGuardar" class="btn small">Guardar vehículo</button>
          <button id="btnLimpiar" class="btn ghost small">Limpiar</button>
        </div>

        <div id="modInfo" class="footer-note"></div>
      </div>
    </aside>
  </main>
</div>

<!-- Login modal -->
<div id="overlay" class="overlay" style="display:none">
  <div class="modal" role="dialog">
    <h2>Panel de inicio de sesión</h2>
    <p>Elige modo y luego ingresa la contraseña correspondiente.</p>

    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button id="modeCivil" class="btn small">Ciudadano</button>
      <button id="modePolicia" class="btn small">Policía</button>
      <button id="modeModerador" class="btn small">Moderador</button>
    </div>

    <div id="loginForm" style="margin-top:8px;display:none">
      <label>Ingresa la contraseña</label>
      <input id="pwInput" class="input" type="password" placeholder="Contraseña">
      <div class="row" style="margin-top:8px">
        <button id="btnLogin" class="btn small">Iniciar sesión</button>
        <button id="btnLoginCancel" class="btn ghost small">Cancelar</button>
      </div>
      <small class="note">Contraseñas (debe saberlas): Policía → <em>CarabinerosDeChileCHCRP</em>, Moderador → <em>ModeracionCHCRP</em>. Para editar estado (policía) se pedirá otra contraseña.</small>
    </div>

    <div id="loginMsg" style="color:var(--danger);margin-top:8px"></div>
  </div>
</div>

<!-- Modal editar estado -->
<div id="overlayEdit" class="overlay" style="display:none">
  <div class="modal" role="dialog">
    <h2>Editar estado del vehículo</h2>
    <p>Para cambiar el estado se requiere la contraseña de edición.</p>

    <label>Contraseña de edición</label>
    <input id="editPass" type="password" placeholder="Contraseña para editar estado (ChileCityRP0703)">

    <label>Nuevo estado</label>
    <select id="newState">
      <option value="Neutro">Neutro</option>
      <option value="Incautado">Incautado</option>
      <option value="Confiscado">Confiscado</option>
    </select>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="btnApplyState" class="btn small">Aplicar estado</button>
      <button id="btnCancelState" class="btn ghost small">Cancelar</button>
    </div>

    <div id="editMsg" style="color:var(--danger);margin-top:8px"></div>
  </div>
</div>

<script>
/* ========== CONFIG (pega TU BIN_ID y TU API_KEY) ========== */
const BIN_ID = "68fcffb343b1c97be9803fbc "; // ej "650d1a2f6f1c12345abc6789"
const API_KEY = "$2a$10$P8Vcs58sRtKtBzlgtXD5E.vvn0cWi9.rQxAgn8/Q.tt3qAyj7sUkO"; // tu X-Master-Key
const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* Contraseñas requeridas (tal como pediste) */
const PASSWORD_POLICIA = "CarabinerosDeChileCHCRP";
const PASSWORD_MODERADOR = "ModeracionCHCRP";
const PASSWORD_EDIT = "ChileCityRP0703"; // contraseña para editar estado (policía)

/* Estado local */
let vehiculos = []; // array de objetos { rut, propietario, marca, modelo, patente, color, anio, estado }
let currentRole = "none"; // 'civil' | 'policia' | 'moderador'
let editTargetIndex = -1;

/* DOM refs */
const btnOpenLogin = document.getElementById("btnOpenLogin");
const overlay = document.getElementById("overlay");
const overlayEdit = document.getElementById("overlayEdit");
const modeCivil = document.getElementById("modeCivil");
const modePolicia = document.getElementById("modePolicia");
const modeModerador = document.getElementById("modeModerador");
const loginForm = document.getElementById("loginForm");
const pwInput = document.getElementById("pwInput");
const btnLogin = document.getElementById("btnLogin");
const btnLoginCancel = document.getElementById("btnLoginCancel");
const loginMsg = document.getElementById("loginMsg");

const cardsEl = document.getElementById("cards");
const emptyStateEl = document.getElementById("emptyState");
const notice = document.getElementById("notice");

const moderatorPanel = document.getElementById("moderatorPanel");
const modInfo = document.getElementById("modInfo");
const moderPass = document.getElementById("moderPass");

const rutI = document.getElementById("rut");
const propI = document.getElementById("propietario");
const marcaI = document.getElementById("marca");
const modeloI = document.getElementById("modelo");
const patenteI = document.getElementById("patente");
const colorI = document.getElementById("color");
const anioI = document.getElementById("anio");
const btnGuardar = document.getElementById("btnGuardar");
const btnLimpiar = document.getElementById("btnLimpiar");

const searchInput = document.getElementById("searchInput");
const btnBuscar = document.getElementById("btnBuscar");
const btnClearSearch = document.getElementById("btnClearSearch");

/* Edit modal refs */
const overlayEditModal = document.getElementById("overlayEdit");
const editPass = document.getElementById("editPass");
const newState = document.getElementById("newState");
const btnApplyState = document.getElementById("btnApplyState");
const btnCancelState = document.getElementById("btnCancelState");
const editMsg = document.getElementById("editMsg");

/* ---------------- Util ---------------- */
function escapeHtml(str){
  if(str === undefined || str === null) return "";
  return String(str).replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#x3D;'}[s]));
}

/* ---------------- JSONBin ---------------- */
async function fetchFromJsonBin(){
  if(!BIN_ID || !API_KEY || BIN_ID.includes("68fcffb343b1c97be9803fbc") || API_KEY.includes("$2a$10$P8Vcs58sRtKtBzlgtXD5E.vvn0cWi9.rQxAgn8/Q.tt3qAyj7sUkO")){
    modInfo.innerText = "Pega BIN_ID y API_KEY en el código para habilitar guardado.";
    return [];
  }
  try{
    modInfo.innerText = "Cargando datos desde JSONBin...";
    const res = await fetch(`${BASE_URL}/latest`, {
      headers: { "X-Master-Key": API_KEY, "Content-Type": "application/json" }
    });
    if(!res.ok) throw new Error("Error " + res.status);
    const data = await res.json();
    const record = data.record || {};
    return Array.isArray(record.vehiculos) ? record.vehiculos : [];
  } catch(err){
    console.error(err);
    modInfo.innerText = "Error cargando JSONBin (ver consola).";
    return [];
  }
}

async function putToJsonBin(arr){
  if(!BIN_ID || !API_KEY || BIN_ID.includes("68fcffb343b1c97be9803fbc") || API_KEY.includes("$2a$10$4ESFRaH74lb6n73Ch1fvaeH2UppEdwKcIP20sub9irW9AgyrMelRW")){
    alert("Configura BIN_ID y API_KEY en el archivo.");
    return false;
  }
  try{
    modInfo.innerText = "Guardando en JSONBin...";
    const res = await fetch(BASE_URL, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify({ vehiculos: arr })
    });
    if(!res.ok) throw new Error("Error " + res.status);
    modInfo.innerText = "Guardado correcto.";
    return true;
  } catch(err){
    console.error(err);
    modInfo.innerText = "Error guardando (ver consola).";
    return false;
  }
}

/* --------------- Render --------------- */
function renderList(list = null){
  const data = Array.isArray(list) ? list : vehiculos;
  cardsEl.innerHTML = "";
  if(!data || data.length === 0){
    emptyStateEl.style.display = "block";
    return;
  } else emptyStateEl.style.display = "none";

  data.forEach((v, idx) => {
    const div = document.createElement("div");
    div.className = "veh-card";
    // status badge
    let statusHtml = `<span class="status-badge status-neutro">Neutro</span>`;
    if(v.estado === "Incautado") statusHtml = `<span class="status-badge status-incautado">Incautado</span>`;
    if(v.estado === "Confiscado") statusHtml = `<span class="status-badge status-confiscado">Confiscado</span>`;

    div.innerHTML = `
      <div class="veh-top">
        <div style="font-weight:700">${escapeHtml(v.propietario || "—")}</div>
        <div style="display:flex;gap:8px;align-items:center">
          ${statusHtml}
          <div class="chip">${escapeHtml(v.patente || "—")}</div>
        </div>
      </div>
      <div style="margin-bottom:6px;color:var(--muted)">${escapeHtml(v.marca || "—")} • ${escapeHtml(v.modelo || "—")} • ${escapeHtml(v.anio || "—")}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div class="chip">RUT: ${escapeHtml(v.rut || "—")}</div>
        <div class="chip">Color: ${escapeHtml(v.color || "—")}</div>
      </div>
      <div style="position:absolute;right:12px;bottom:12px;display:flex;gap:8px">
        ${ currentRole === 'moderador' ? `<button data-idx="${idx}" class="btn small deleteBtn">Eliminar</button>` : '' }
        ${ (currentRole === 'policia' || currentRole === 'moderador') ? `<button data-idx="${idx}" class="btn small selectBtn">Seleccionar</button>` : '' }
      </div>
    `;
    cardsEl.appendChild(div);
  });

  // attach handlers
  if(currentRole === 'moderador'){
    document.querySelectorAll(".deleteBtn").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const i = Number(e.currentTarget.dataset.idx);
        if(!confirm("¿Eliminar este vehículo?")) return;
        vehiculos.splice(i,1);
        const ok = await putToJsonBin(vehiculos);
        if(ok) renderList();
      });
    });
  }

  // Selecting (police edit or moderator quick select)
  document.querySelectorAll(".selectBtn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const i = Number(e.currentTarget.dataset.idx);
      openEditStateModal(i);
    });
  });
}

/* --------------- Search --------------- */
btnBuscar.addEventListener("click", ()=>{
  const q = (searchInput.value || "").toLowerCase().trim();
  if(!q){ renderList(); return; }
  const filtrados = vehiculos.filter(v => (v.propietario||"").toLowerCase().includes(q));
  renderList(filtrados);
});
btnClearSearch.addEventListener("click", ()=>{
  searchInput.value = "";
  renderList();
});

/* --------------- Moderator actions --------------- */
btnGuardar.addEventListener("click", async ()=>{
  // confirm form-level password
  const pass = moderPass.value || "";
  if(pass !== PASSWORD_MODERADOR){
    alert("Contraseña de formulario incorrecta (ModeracionCHCRP).");
    return;
  }
  const rut = (rutI.value||"").trim();
  const prop = (propI.value||"").trim();
  const marca = (marcaI.value||"").trim();
  const modelo = (modeloI.value||"").trim();
  const patente = (patenteI.value||"").trim();
  if(!rut || !prop || !marca || !modelo || !patente){
    alert("Completa los campos obligatorios: RUT, Propietario, Marca, Modelo, Patente.");
    return;
  }
  const nuevo = {
    rut,
    propietario: prop,
    marca,
    modelo,
    patente,
    color: (colorI.value||"").trim(),
    anio: anioI.value?anioI.value.toString():"",
    estado: "Neutro"
  };
  vehiculos.unshift(nuevo);
  const ok = await putToJsonBin(vehiculos);
  if(ok){
    clearForm();
    renderList();
    alert("Vehículo agregado.");
  } else alert("Error guardando.");
});

btnLimpiar.addEventListener("click", clearForm);
function clearForm(){
  moderPass.value=""; rutI.value=""; propI.value=""; marcaI.value=""; modeloI.value=""; patenteI.value=""; colorI.value=""; anioI.value="";
}

/* --------------- Edit state (police) --------------- */
function openEditStateModal(index){
  editTargetIndex = index;
  editPass.value = "";
  newState.value = vehiculos[index] && vehiculos[index].estado ? vehiculos[index].estado : "Neutro";
  editMsg.innerText = "";
  overlayEditModal.style.display = "flex";
}

btnCancelState.addEventListener("click", ()=>{ overlayEditModal.style.display = "none"; });

btnApplyState.addEventListener("click", async ()=>{
  const pass = editPass.value || "";
  if(pass !== PASSWORD_EDIT){
    editMsg.innerText = "Contraseña de edición incorrecta.";
    return;
  }
  const estado = newState.value;
  if(editTargetIndex < 0 || editTargetIndex >= vehiculos.length){
    editMsg.innerText = "Vehículo no válido.";
    return;
  }
  vehiculos[editTargetIndex].estado = estado;
  const ok = await putToJsonBin(vehiculos);
  if(ok){
    overlayEditModal.style.display = "none";
    renderList();
    alert("Estado actualizado.");
  } else {
    editMsg.innerText = "Error guardando estado (ver consola).";
  }
});

/* --------------- Login / Roles --------------- */
btnOpenLogin.addEventListener("click", ()=>{ overlay.style.display = "flex"; loginForm.style.display="none"; loginMsg.innerText=""; pwInput.value=""; });

modeCivil.addEventListener("click", ()=>{ currentRole = 'civil'; loginForm.style.display="none"; loginMsg.innerText="Entrando como ciudadano..."; setTimeout(()=>{ overlay.style.display='none'; applyRole(); }, 350); });
modePolicia.addEventListener("click", ()=>{ currentRole = 'policia'; loginForm.style.display="block"; loginMsg.innerText=""; });
modeModerador.addEventListener("click", ()=>{ currentRole = 'moderador'; loginForm.style.display="block"; loginMsg.innerText=""; });

btnLoginCancel.addEventListener("click", ()=>{ overlay.style.display='none'; loginForm.style.display='none'; loginMsg.innerText=''; });

btnLogin.addEventListener("click", ()=>{
  const pass = pwInput.value || "";
  if(currentRole === 'policia'){
    if(pass === PASSWORD_POLICIA){
      overlay.style.display='none';
      applyRole();
    } else loginMsg.innerText = "Contraseña Policía incorrecta.";
  } else if(currentRole === 'moderador'){
    if(pass === PASSWORD_MODERADOR){
      overlay.style.display='none';
      applyRole();
    } else loginMsg.innerText = "Contraseña Moderador incorrecta.";
  } else {
    loginMsg.innerText = "Selecciona un modo primero.";
  }
});

function applyRole(){
  // set UI by role
  if(currentRole === 'civil'){
    moderatorPanel.style.display = 'none';
    notice.style.display = 'block';
    notice.querySelector('.muted').innerText = "Modo Civil: solo ver vehículos.";
  } else if(currentRole === 'policia'){
    moderatorPanel.style.display = 'none';
    notice.style.display = 'block';
    notice.querySelector('.muted').innerText = "Modo Policía: seleccionar vehículo -> solicitar contraseña para editar estado.";
  } else if(currentRole === 'moderador'){
    moderatorPanel.style.display = 'block';
    notice.style.display = 'block';
    notice.querySelector('.muted').innerText = "Modo Moderador: registra y elimina vehículos.";
  } else {
    moderatorPanel.style.display = 'none';
    notice.style.display = 'none';
  }
  // load vehicles
  cargarVehiculos();
}

/* --------------- Cargar / Init --------------- */
async function cargarVehiculos(){
  vehiculos = await fetchFromJsonBin();
  renderList();
}

// initial load
window.addEventListener("load", async ()=>{
  // start closed; load data for preview if credentials exist
  if(BIN_ID && API_KEY && !BIN_ID.includes("68fcffb343b1c97be9803fbc") && !API_KEY.includes("$2a$10$4ESFRaH74lb6n73Ch1fvaeH2UppEdwKcIP20sub9irW9AgyrMelRW")){
    vehiculos = await fetchFromJsonBin();
    renderList();
  } else {
    // no credentials: still render empty
    vehiculos = [];
    renderList();
    modInfo.innerText = "Sistema
vehicular.";
  }
});
</script>
</body>
</html>