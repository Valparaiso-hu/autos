<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MDT | Concesionario</title>
<style>
:root{
  --purple-1:#4b1070;
  --purple-2:#7a3fb2;
  --white:#ffffff;
  --muted:#ccc;
}
*{box-sizing:border-box;font-family:Inter, Arial, sans-serif;margin:0;padding:0;}
body{background:linear-gradient(180deg,#4b1070,#7a3fb2);color:var(--white);padding:20px;}
.wrap{max-width:1100px;margin:0 auto;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
header h1{font-size:24px;color:var(--white);}
header .note{font-size:14px;color:var(--muted);}
button{padding:8px 12px;border-radius:6px;border:none;background:var(--white);color:var(--purple-1);cursor:pointer;font-weight:700;}
button.ghost{background:transparent;border:2px solid var(--white);color:var(--white);}
.field-small{padding:6px;border-radius:6px;border:1px solid var(--white);background:transparent;color:var(--white);}
.main{background:rgba(255,255,255,0.05);padding:16px;border-radius:10px;margin-top:12px;}
.table-wrap{overflow-x:auto;margin-top:12px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
th{background:rgba(255,255,255,0.1);color:var(--white);}
.estado-text{cursor:pointer;text-decoration:underline dotted;}
select.estado-select{padding:4px;border-radius:4px;}
.login-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:999;}
.login-box{background:#2b0b3a;padding:20px;border-radius:12px;width:100%;max-width:400px;}
.login-box label{display:block;margin-top:8px;color:var(--white);}
.login-box input{width:100%;padding:8px;border-radius:6px;border:1px solid var(--white);margin-top:6px;background:transparent;color:var(--white);}
.hide{display:none;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>MDT | Concesionario</h1>
    <div class="note">Acceso controlado • Morado & Blanco</div>
  </header>

  <!-- Login overlay -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>Panel de acceso</h2>
      <label>Contraseña policía</label>
      <input id="passPolicia" type="password" placeholder="Contraseña Policía">
      <label>Contraseña moderador</label>
      <input id="passModerador" type="password" placeholder="Contraseña Moderador">
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnCivil">Entrar como Civil</button>
        <button id="btnLogin">Ingresar</button>
      </div>
      <div style="margin-top:10px;font-size:12px;color:#ddd;">Civil: solo ver. Policía: cambiar estado. Moderador: registrar autos.</div>
    </div>
  </div>

  <main class="main" aria-hidden="true">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
      <div><button id="btnAgregar" class="ghost hide">Agregar Auto</button></div>
      <div>
        <input id="inputBuscar" class="field-small" placeholder="Buscar por RUT, Nombre o Patente">
        <button id="btnBuscar">Buscar</button>
        <button id="btnRefrescar" class="ghost">Refrescar</button>
      </div>
      <div style="margin-left:auto">Modo: <strong id="modoLabel">No autenticado</strong></div>
    </div>

    <!-- Form agregar auto -->
    <div id="formAdd" class="hide">
      <h3>Agregar Auto</h3>
      <input id="rut" placeholder="RUT">
      <input id="prop" placeholder="Propietario">
      <input id="marca" placeholder="Marca">
      <input id="modelo" placeholder="Modelo">
      <input id="patente" placeholder="Patente">
      <input id="color" placeholder="Color">
      <input id="anio" type="number" placeholder="Año">
      <div style="margin-top:8px;display:flex;gap:6px;">
        <button id="guardarBtn">Guardar</button>
        <button id="cancelBtn" class="ghost">Cancelar</button>
      </div>
    </div>

    <!-- Tabla autos -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>RUT</th>
            <th>Propietario</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Patente</th>
            <th>Color</th>
            <th>Año</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<script>
const BIN_ID = "68fcffb343b1c97be9803fbc"; // tu Bin ID
const API_KEY = "$2a$10$P8Vcs58sRtKtBzlgtXD5E.vvn0cWi9.rQxAgn8/Q.tt3qAyj7sUkO"; // X-Master-Key
const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

const PASS_POLICIA = "CarabinerosDeChileCHCRP";
const PASS_MODERADOR = "ModeracionCHCRP";
const PASS_ESTADO = "ChileCityRP0703";

let autos = [];
let modo = "civil";

const loginOverlay = document.getElementById("loginOverlay");
const passPolicia = document.getElementById("passPolicia");
const passModerador = document.getElementById("passModerador");
const btnLogin = document.getElementById("btnLogin");
const btnCivil = document.getElementById("btnCivil");
const modoLabel = document.getElementById("modoLabel");

const btnAgregar = document.getElementById("btnAgregar");
const formAdd = document.getElementById("formAdd");
const guardarBtn = document.getElementById("guardarBtn");
const cancelBtn = document.getElementById("cancelBtn");

const rutI = document.getElementById("rut");
const propI = document.getElementById("prop");
const marcaI = document.getElementById("marca");
const modeloI = document.getElementById("modelo");
const patenteI = document.getElementById("patente");
const colorI = document.getElementById("color");
const anioI = document.getElementById("anio");

const inputBuscar = document.getElementById("inputBuscar");
const btnBuscar = document.getElementById("btnBuscar");
const btnRefrescar = document.getElementById("btnRefrescar");
const tbody = document.getElementById("tbody");

/* JSONBin */
async function cargarAutos(){
  try{
    const res = await fetch(`${BASE_URL}/latest`, { headers: {"X-Master-Key":API_KEY} });
    const json = await res.json();
    autos = (json.record && json.record.autos) ? json.record.autos : [];
    renderTabla();
  }catch(e){console.error(e);}
}
async function guardarAutos(){
  try{
    await fetch(BASE_URL,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},body:JSON.stringify({autos})});
  }catch(e){console.error(e);}
}

/* Login */
btnLogin.addEventListener("click",()=>{
  const pP = passPolicia.value.trim();
  const pM = passModerador.value.trim();
  if(pM===PASS_MODERADOR){
    modo="moderador";
  } else if(pP===PASS_POLICIA){
    modo="policia";
  } else {
    alert("Contraseña incorrecta"); return;
  }
  loginOverlay.style.display="none";
  modoLabel.textContent=modo.charAt(0).toUpperCase()+modo.slice(1);
  if(modo==="moderador") btnAgregar.classList.remove("hide");
  document.querySelector("main").setAttribute("aria-hidden","false");
  cargarAutos();
});

btnCivil.addEventListener("click",()=>{
  modo="civil";
  loginOverlay.style.display="none";
  modoLabel.textContent="Civil";
  document.querySelector("main").setAttribute("aria-hidden","false");
  cargarAutos();
});

/* Render tabla */
function renderTabla(){
  tbody.innerHTML="";
  autos.forEach((a,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.rut}</td>
      <td>${a.prop}</td>
      <td>${a.marca}</td>
      <td>${a.modelo}</td>
      <td>${a.patente}</td>
      <td>${a.color}</td>
      <td>${a.anio}</td>
      <td class="td-estado"></td>
      <td></td>
    `;
    const statusCell = tr.querySelector(".td-estado");
    const span = document.createElement("span");
    span.className="estado-text";
    span.textContent=a.estado||"Neutro";
    if(modo==="policia"){
      span.addEventListener("click",()=>{
        const clave = prompt("Ingrese contraseña para cambiar estado:");
        if(clave!==PASS_ESTADO){alert("Contraseña incorrecta"); return;}
        const sel = document.createElement("select");
        ["Neutro","Incautado","Confiscado"].forEach(o=>{
          const opt = document.createElement("option");
          opt.value=o; opt.text=o;
          if(o===a.estado) opt.selected=true;
          sel.appendChild(opt);
        });
        sel.addEventListener("change",()=>{
          a.estado=sel.value;
          guardarAutos();
          renderTabla();
        });
        span.replaceWith(sel);
      });
    }
    statusCell.appendChild(span);

    const actionsCell = tr.children[8];
    if(modo==="moderador"){
      const btnDel=document.createElement("button");
      btnDel.textContent="Borrar";
      btnDel.addEventListener("click",()=>{
        if(confirm("Eliminar auto?")){
          autos.splice(idx,1);
          guardarAutos();
          renderTabla();
        }
      });
      actionsCell.appendChild(btnDel);
    }
    tbody.appendChild(tr);
  });
}

/* Agregar auto */
btnAgregar.addEventListener("click",()=>{formAdd.classList.remove("hide");});
cancelBtn.addEventListener("click",()=>{formAdd.classList.add("hide");rutI.value="";propI.value="";marcaI.value="";modeloI.value="";patenteI.value="";colorI.value="";anioI.value="";});
guardarBtn.addEventListener("click",()=>{
  const nuevo={rut:rutI.value,prop:propI.value,marca:marcaI.value,modelo:modeloI.value,patente:patenteI.value,color:colorI.value,anio:anioI.value,estado:"Neutro"};
  autos.push(nuevo);
  guardarAutos();
  renderTabla();
  formAdd.classList.add("hide");
  rutI.value="";propI.value="";marcaI.value="";modeloI.value="";patenteI.value="";colorI.value="";anioI.value="";
});

/* Buscar */
btnBuscar.addEventListener("click",()=>{
  const q=inputBuscar.value.toLowerCase();
  const filtrados=autos.filter(a=>a.rut.toLowerCase().includes(q)||a.prop.toLowerCase().includes(q)||a.patente.toLowerCase().includes(q));
  tbody.innerHTML="";
  filtrados.forEach((a,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.rut}</td>
      <td>${a.prop}</td>
      <td>${a.marca}</td>
      <td>${a.modelo}</td>
      <td>${a.patente}</td>
      <td>${a.color}</td>
      <td>${a.anio}</td>
      <td>${a.estado}</td>
      <td></td>
    `;
    tbody.appendChild(tr);
  });
});
btnRefrescar.addEventListener("click",()=>{inputBuscar.value="";renderTabla();});
</script>
</body>
</html>